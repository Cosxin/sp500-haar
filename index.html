<!DOCTYPE html>
<html>
    <head>
        <title>D3.js Charts</title>
	<script src="./d3.min.js"></script>
    </head>
    <style>
    .background {
  		fill: #eee;
	}

	line {
  		stroke: #fff;
	}
	text.active {
  		fill: red;
	}
	.cell {
	}
	.brush {
		fill:purple;
	}
	.brush rect.extent {
  		fill: #2ca25f;
  		fill-opacity: .125;
  		stroke:purple;
	}
	.brush rect.background{
		fill: #e5f5f9;
	}
	.brush .resize path {
  		fill: #eee;
  		stroke: #666;
	}
	.offselected {
		fill-opacity:0.3;
		-webkit-transition: fill-opacity 250ms linear;

	}
	.selected{
		fill-opacity:1.0;
		-webkit-transition: fill-opacity 250ms linear;

	}
?
</style>
    <body>
    h
    </body>

    <script>

    var margin = {top:50,right:0,bottom:0,left:80},
    	width = 1050,
    	height = 1050,
    	bwidth = 30,
    	bheight = 30,
    	awidth = 10,
    	aheight = 10,
	    n = 50,
	    MaxS = 60,
	    Ns = 10,
	    sliceX1 = 0,
	    sliceX2 = 30,
	    sliceY1 = 0,
	    sliceY2 = 30;
	    //pwidth = width - bwidth,
	    //pheight = height - bheight;

    var matrix = [];
    var wavelet = [];

    for(i = -1;++i<n;){
    	wavelet[i] = [];
    	for(j = -1;++j<MaxS;)
    		wavelet[i].push(Math.random());
    }
    
    var x = d3.scale.ordinal().rangeBands([0,width]),
    	y = d3.scale.ordinal().rangeBands([0,height]),
        z = d3.scale.linear().domain([-1,-0.7,0,+0.7,+1]).range(['#1a9641','#a6d96a','#ffffbf','#fdae61','#d7191c']); //colorbrewer2.0 org


    var alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    var nums = "0123456789".split("");
    var alphanumeric = d3.range(n).map(function(d,i){return alphabet[Math.floor(i/10)] + nums[Math.floor(i%10)];});
	
	for(i = -1; ++i<n; ){
		//matrix i is a row
    	matrix[i] = d3.range(n).map(function(j){return {x:j,y:i,z:Math.abs(Math.sin(i + j))};});
    	matrix[i].name = alphanumeric[i];
	}

	var orders = {
		name: d3.range(n).sort(function(a,b){return d3.ascending(matrix[a].name,matrix[b].name);}),
		correlation_x:d3.range(n).sort(function(a,b){return matrix[a].x - matrix[b].x;}),
		correlation_y:d3.range(n).sort(function(a,b){return matrix[a].y - matrix[b].y;}),
		industry:d3.range(n).sort(function(a,b){return d3.ascending(matrix[a].industry , matrix[b].industry);})
	};
	x.domain(d3.range(n));
	y.domain(d3.range(n));
//	x.domain(orders.correlation_x);
//	y.domain(orders,correlation_y);


    //var bs = d3.scale.ordinal().domain(d3.range(60)).rangeRoundPoints([0,width]);
    var bs = d3.scale.linear().domain([0,n]).rangeRound([0,width]);


	var brushX = d3.svg.brush().x(bs).on("brush",brushed).on("brushend",brushed),
		brushY = d3.svg.brush().y(bs).on("brush",brushed).on("brushend",brushed);
	var xAxis = d3.svg.axis().scale(bs).orient("top")
		yAxis = d3.svg.axis().scale(bs).orient("left");


	var svg = d3.select('body').append('svg')
	    .attr('width', width + margin.left + margin.right + bwidth)
	    .attr('height', height + margin.top + margin.bottom + bheight)
	  .append('g')
	    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

	var brushx = svg
		 .append("g")
		 .attr('transform', 'translate(' + bwidth + ',' + 0 + ')')
		 .attr("class","brush x")
		 .call(brushX);

	brushx.selectAll("rect")
		 .attr("height",bheight)
		 .style("visibility","visible");
	

	var brushy = svg.append("g")
		.attr('transform', 'translate(' + 0 + ',' + bheight + ')')
		.attr("class", "brush y")
		.call(brushY);

	brushy.selectAll("rect")
		 .attr("width",bwidth)
		 .style("visibility","visible");


	var panel = svg.append("g")
		.attr('transform', 'translate(' + bwidth + ',' + bheight  + ')')

	panel.append("rect")
		.attr('class',"background")
		.attr("width",width)
		.attr("height",height)

	redraw();

	function redraw(){

	row = panel.selectAll(".row")
		.data(matrix)
	   .enter().append("g")
	    .attr("class","row")
	    .attr('transform', function(d,i){return 'translate(' + 0 + ',' + x(i) + ')';})
	    .each(frow);

	row.append("line")
	    .attr("x2", width);

	row.append("text")
	    .attr("x", -3)
	    .attr("y", x.rangeBand() / 2)
	    .attr("font-size","9px")
	    .attr("dy", ".16em")
	    .attr("text-anchor", "end")
	    .text(function(d, i) { return alphanumeric[i]; })
	    .style("-webkit-user-select","none")
		.style("-moz-user-select","none");


	column = panel.selectAll(".column")
		.data(matrix)
	   .enter().append("g")
	   	.attr('class',"column")
	   	.attr("transform",function(d,i){return 'translate(' + x(i) +  ')rotate(-90)';});

	column.append("line")
		.attr("x1",-width);

	column.append("text")
		.attr('x',6)
		.attr('y',x.rangeBand() / 2)
		.attr('dy', ".32em")
		.attr('font-size','9px' )
		.attr('text-anchor','start')
		.text(function(d,i){return alphanumeric[i];})
		.style("-webkit-user-select","none")
		.style("-moz-user-select","none");

}
	function frow(row){
		 var cell = d3.select(this).selectAll(".cell")
			 .data(row)
		    .enter().append("rect")
		     .attr('class',"cell")
		     .attr('x', function(d,i){return x(d.x);})
		     .attr('height',x.rangeBand())
		     .attr('width',x.rangeBand())
		     .style("fill",function(d){return z(d.z);})
		     .on("mouseover",mouseover)
		     .on("mouseout",mouseout);
}

brushX.extent()[0] = 0;
  function order(value) {
    x.domain(orders[value]);

    var t = svg.transition().duration(2500);

    t.selectAll(".row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .selectAll(".cell")
        .delay(function(d) { return x(i) * 4; })
        .attr("x", function(d) { return x(i); });

    t.selectAll(".column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
  }

  function mouseover(p){
    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.x; });
    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.y; });
  }

  function mouseout() {
    d3.selectAll("text").classed("active", false);
  }


  function brushed(){
  	var x = brushX.extent();
  	var y = brushY.extent();
  	if (x[0] == x[1]) {x[0]=0;x[1]=width;}
  	if (y[0] == y[1]) {y[0]=0;y[1]=height;}

  	d3.selectAll(".cell").classed("offselected",function(d){
  		return (d.x) < x[0] - .5 || (d.x) > x[1] - .5 || (d.y) > y[1] -.5 || (d.y) < y[0] -.5 ;
  	});
  	d3.selectAll(".cell").classed("selected",function(d){
  		return (d.x) > x[0] - .5 && (d.x) < x[1] - .5 && (d.y) < y[1] -.5 && (d.y) > y[0] -.5 ;
  	});
  }

	//auto pull data 
	var task = setInterval(function(){
		wavelet.forEach(function(d){
			//if there is data available
			d.shift();
			d.push(Math.random());
			//otherwise, use last tick's data
			//d.shift();
			//d.push(d[d.length-1]);
		});
		console.log("new data recieved");
		updateZ(correlation);
	},2000);

	function updateZ(func){
		wavelet.forEach(function(d,i){
			wavelet.forEach(function(k,j){
				matrix[i][j].z = func(d.slice(sliceX1,sliceX2),k.slice(sliceY1,sliceY2));
			});
		});
		d3.selectAll(".cell").style("fill",function(d){return z(matrix[d.x][d.y].z);});
	}

	d3.selectAll(".cell").each(function(d){console.log(d.x);});

	function correlation(wave1,wave2){
		var mu1 = d3.mean(wave1);
		var mu2 = d3.mean(wave2);
		var sig1 = d3.deviation(wave1);
		var sig2 = d3.deviation(wave2);
		var sum = 0;
		for(var i = -1; ++i < d3.min([wave1.length,wave2.length]); )
			sum += (wave1[i] - mu1) * (wave2[i] - mu2);
		return sum / ((d3.min([wave1.length,wave2.length]) - 1) * sig2 * sig1);

	}
    </script>
</html>
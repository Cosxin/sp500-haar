<!DOCTYPE html>
<html>
    <head>
        <title>D3.js Charts</title>
	<script src="./d3.min.js"></script>
    </head>
    <style>
    .background {
  	fill: #eee;
	}

	line {
  	stroke: #fff;
	}

	text.active {
  	fill: red;
	}

</style>
    <body>
    h
    </body>

    <script>

    var margin = {top:50,right:0,bottom:0,left:80},
    width = 1050,
    height = 1050,
    n = 100,
    MaxS = 60;
    Ns = 10
    sliceX1 = 0,
    sliceX2 = 10,
    sliceY1 = 0,
    sliceY2 = 10;

    var matrix = [];
    var wavelet = [];

    for(i = -1;++i<n;){
    	wavelet[i] = [];
    	for(j = -1;++j<MaxS;)
    		wavelet[i].push(Math.random());
    }
    
    var x = d3.scale.ordinal().rangeBands([0,width]),
    	y = d3.scale.ordinal().rangeBands([0,height]),
    //var x = d3.scale.linear().domain([0,width]),
        //z = d3.scale.category10().domain([-1,1]);
        z = d3.scale.linear().domain([-1,1]).range(['#00FFFF','#FF0000']);
    	
    var alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    var nums = "0123456789".split("");
    var alphanumeric = d3.range(n).map(function(d,i){return alphabet[Math.floor(i/10)] + nums[Math.floor(i%10)];});
	
	for(i = -1; ++i<n; ){
		//matrix i is a row
    	matrix[i] = d3.range(n).map(function(j){return {x:i,y:j,z:Math.abs(Math.sin(i + j))};});
    	matrix[i].name = alphanumeric[i];
	}

	var orders = {
		name: d3.range(n).sort(function(a,b){return d3.ascending(matrix[a].name,matrix[b].name);}),
		correlation_x:d3.range(n).sort(function(a,b){return matrix[a].x - matrix[b].x;}),
		correlation_y:d3.range(n).sort(function(a,b){return matrix[a].y - matrix[b].y;}),
		industry:d3.range(n).sort(function(a,b){return d3.ascending(matrix[a].industry , matrix[b].industry);})
	};
	x.domain(d3.range(n));
	y.domain(d3.range(n));
//	x.domain(orders.correlation_x);
//	y.domain(orders,correlation_y);

	var svg = d3.select('body').append('svg')
	    .attr('width', width + margin.left + margin.right)
	    .attr('height', height + margin.top + margin.bottom)
	    //.style('margin-left', -margin.left + "px")
	  .append('g')
	    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

	svg.append("rect")
		.attr('class',"background")
		.attr("width",width)
		.attr("height",height);

	redraw();

	function redraw(){

	row = svg.selectAll(".row")
		.data(matrix)
	   .enter().append("g")
	    .attr("class","row")
	    .attr('transform', function(d,i){return 'translate(' + 0 + ',' + x(i) + ')';})
	    .each(frow);

	row.append("line")
	    .attr("x2", width);

	row.append("text")
	    .attr("x", -3)
	    .attr("y", x.rangeBand() / 2)
	    .attr("font-size","9px")
	    .attr("dy", ".16em")
	    .attr("text-anchor", "end")
	    .text(function(d, i) { return alphanumeric[i]; });

	column = svg.selectAll(".column")
		.data(matrix)
	   .enter().append("g")
	   	.attr('class',"column")
	   	.attr("transform",function(d,i){return 'translate(' + x(i) +  ')rotate(-90)';});

	column.append("line")
		.attr("x1",-width);

	column.append("text")
		.attr('x',6)
		.attr('y',x.rangeBand() / 2)
		.attr('dy', ".32em")
		.attr('font-size','9px' )
		.attr('text-anchor','start')
		.text(function(d,i){return alphanumeric[i];});

}
	function frow(row){
		 var cell = d3.select(this).selectAll(".cell")
			 .data(row)
		    .enter().append("rect")
		     .attr('class',"cell")
		     .attr('x', function(d,i){return x(d.y);})
		     .attr('height',x.rangeBand())
		     .attr('width',x.rangeBand())
		     .style("fill",function(d){return z(d.z);});

}

  function order(value) {
    x.domain(orders[value]);

    var t = svg.transition().duration(2500);

    t.selectAll(".row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .selectAll(".cell")
        .delay(function(d) { return x(i) * 4; })
        .attr("x", function(d) { return x(i); });

    t.selectAll(".column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
  }


	var task = setInterval(function(){
		wavelet.forEach(function(d){
			d.shift();
			d.push(Math.random());
		});
		console.log("new data recieved");
		updateZ(correlation);
	},2000);

	function updateZ(func){
		wavelet.forEach(function(d,i){
			wavelet.forEach(function(k,j){
				matrix[i][j].z = func(d.slice(sliceX1,sliceX2),k.slice(sliceY1,sliceY2));
			});
		});
		row.remove();
		redraw();
	}
	function correlation(wave1,wave2){
		var mu1 = d3.mean(wave1);
		var mu2 = d3.mean(wave2);
		var sig1 = d3.deviation(wave1);
		var sig2 = d3.deviation(wave2);
		var sum = 0;
		for(var i = -1; ++i < d3.min([wave1.length,wave2.length]); )
			sum += (wave1[i] - mu1) * (wave2[i] - mu2);
		return sum / ((d3.min([wave1.length,wave2.length]) - 1) * sig2 * sig1);

	}
    </script>
</html>